# 第18章 代码设计

## 18.1 设计易读的代码

维护的需要 + 团队协作的需要

### 18.1.1 格式

1. 使用缩进与对齐表达逻辑结构

2. 将相关逻辑组织在一起
3. 使用空行分割逻辑
4. 语句分行

### 18.1.2 命名

1. 使用有意义的名称进行命名
2. 名称要与实际内容相符
3. 如果存在惯例，命名时要遵守惯例
4. 临时变最命名要符合常规
5. 不要使用太长的名称，不利于拼写和记忆
6. 不要使用易混字符进行命名
7. 不要仅仅使用不易区分的多个名称
8. 不要使用没有任何逻辑的字母缩写进行命名

### 18.1.3 注释

1. 文档注释

   - 注释类型
   - 文档注释的内容与格式
     - 文档注释是专门用来文档化代码的注释，专门注释：
       - 包的总结和概述（每个包都要有概述）
       - 类和接口的描述（每个类和接口都要有概述）
       - 类方法的描述（每个方法都要有功能概述，都要定义完整的接口描述）
       - 字段的描述（重要字段含义、用法与约束的描述）

   - Javadoc

2. 内部注释

   - 注释要有意义，不要简单重复代码的含义
   - 重视对数据类型的注释
   - 重视对复杂控制结构的注释



## 18.2 设计易维护的代码

### 18.2.1 小型任务

- 每个函数或方法的代码应该是内聚的，恰好完成一个功能与目标
- 如果内聚的代码本身比较简单，复杂性可控，那么它就具有比较好的可维护性。反之，内聚的代码也可以比较复杂，则需要将其进一步分解为多个高内聚、低耦合的小型任务
- 通过将不同的代码片段抽象为不同的任务接口，可以解决复杂代码的几种不理想但无法回避的内聚一时间内聚、过程内聚和通信内聚

### 18.2.2 复杂决策

1. 使用新的布尔变量简化复杂决策
2. 使用有意义的名称封装复杂决策
3. 表驱动编程：对于特别复杂的决策，可以将其包装为决策表，然后使用表驱动编程

### 18.2.3 数据使用

1. 不要将变量应用于与命名不相符的目的

2) 不要将单个变量用于多个目的
3) 限制全局变量的使用，如果不得不使用全局变量，就明确注释全局变量的声明和使用处。
4) 不要使用突兀的数字与字符

### 18.2.4 明确依赖关系

类之间模糊的依赖关系会影响到代码的理解与修改，非常容易导致修改时产生未预期的连锁反应。对于这些模糊的依赖关系，需要进行明确的注释。

## 18.3 设计可靠的代码

### 18.3.1 契约式设计（断言式设计）

基本思想：如果一个函数或方法，在前置条件满足的情况下开始执行，完成后能够满足后置条件，那么这个函数或方法就是正确、可靠的

两种常见的编程方式：异常与断言

1. **异常**方式：在代码开始执行时，检查前置条件是否满足，如果不满足就抛出异常。在代码执行完之后，再检查后置条件是否满足，不满足也抛出异常。

2. **断言**方式
3. 比较

### 18.3.2 防御式编程

基本思想：在一个方法与其他方法、操作系统、硬件等外界环境交互时，不能确保外界都是正确的，所以要在外界发生错误时，保护方法内部不受损害。

1. 防御式编程往往会带来比较冗余和复杂的代码，但是会有效地提高程序的抗干扰能力和回复能力，有利于人机交互。
2. 和契约式没有本质的区别，关注点不同
   1. 契约式偏向于避免问题
   2. 防御式偏向于问题发生后进行保护

## 18.4 使用模型辅助设计复杂代码
代码设计常用的模型手段包括：决策表（decision table）、伪代码和程序流程图（program flow chart）

### 18.4.1 决策表

一种决策逻辑的表示方法，用于描述复杂决策逻辑

<img src="./18代码设计/image-20240610150413281.png" alt="image-20240610150413281" style="zoom: 50%;" />

条件声明是进行决策时需要参考的变量列表。条件选项是那些变量可能的取值。动作声明是决策后可能采取的动作。动作选项表明那些动作会在怎样的条件下发生。

### 18.4.2 伪代码

- 叙述上采用了编程语言的三种控制结构：顺序、条件决策和循环
- 使用了一些类似于编程语言关键字的词语来表明叙述的逻辑
- 在格式上，使用和编程语言相同的缩进方式来表明程序逻辑结构
- 尽量使用简短语句以利于理解，只使用名词和动词，避免使用容易产生歧义的形容词和副词

### 18.4.3 程序流程图



## 18.5 为代码开发单元测试用例

### 18.5.1 为方法开发测试用例

为方法开发测试用例主要使用两种线索：**方法的规格**；**方法代码的逻辑结构**

- 根据第一种线索，可以使用基于规格的测试技术开发测试用例。等价类划分和边界值分析是开发单元测试用例常用的黑盒测试方法
- 根据第二种线索，可以使用基于代码的测试技术开发测试用例。对关键、复杂的代码使用路径覆盖，对复杂代码使用分支覆盖，简单情况使用语句覆盖

### 18.5.2 使用Mock Object测试类方法



### 18.5.3 为类开发测试用例

在复杂类中，常常有着多变的状态，每次一个方法的执行改变了类状态时，都会给其他方法带来影响，也就是说复杂类的多个方法间是互相依赖的。

所以，除了测试类的每一个方法之外，还要测试类不同方法之间的互相影响情况。

我们使用状态图来辅助我们分析，通过状态图生成测试用例线索表，最后生成一个测试用例



## 18.6 代码复杂度度量

1. **圈复杂度**
   - 建立程序的流程图G，假设图的节点数为N，边数为E，那么复杂度V(G)=E-N+2
   - 还有一种简单的算法是直接计数程序中决策点的数量：
     - 从 1 开始，一直往下通过程序
     - 一旦遇到下列关键字或者同类的词，就加1：if、while 、repeat、for 
     - 给case 语句中的每一种情况都加 1 

2. 类的复杂度
   - 类的加权方法 = $\sum_{i=1}^n C_i$
   - 其中，$n$ 为一个类的方法数量，$C_i$ 是第 $i$​ 个方法的代码复杂度\



## 18.7 问题代码



## 18.8 项目实践