# 实验五: Cache和程序访问的局部性

## 实验目的

通过实际程序的执行结果，了解程序访问的局部性对带有Cache 的计算机系统性能的影响。



## 实验要求

在以下程序中，修改或添加必要的语句(如计时函数等)，以计算和打印主体程序段的执行时间。分别以M=1000，N=10；M=100，N=100；M=10，N=1000，执行程序A和程序B，以比较两个程序执行时间的长短。

程序段 A assign-array-rows ()

{
int i, j, a\[M][N]; ...... 

for (i= 0; i<M; i++)
for (j= 0; j<N; j++)

a[i][j]=i+j; ...... 

} 

程序段 B assign-array-cols ()

{
int i, j, a\[M][N]; ......
for (j= 0; j<N; j++)

for (i=0; i<M; i++) a[i][j]=i+j;

...... 

} 



## 实验内容

程序A和B使用了Windows平台特有的`QueryPerformanceCounter`和`QueryPerformanceFrequency`函数来进行高精度计时。

- **开始计时**：在循环开始之前，调用`QueryPerformanceCounter(&nBeginTIME);`记录当前的高精度计数器值。
- **结束计时**：在循环结束后，再次调用`QueryPerformanceCounter(&nEndTIME);`记录结束时的计数器值。
- **计算经过时间**：使用`QueryPerformanceFrequency(&nFreq);`获取计数器的频率，然后用结束时间减去开始时间，再除以频率，得到实际运行的秒数。

由于`QueryPerformanceCounter`提供高精度的时间测量，它能够非常准确地反映程序段的执行时间。这对于性能分析非常重要，尤其是在比较不同代码段或优化算法时。并且，虽然`QueryPerformanceCounter`提供了高精度的计时，但它的调用本身几乎不会对程序性能造成显著影响，特别是在长时间运行的代码段中。



### 实验结果

| 实验序号 |  M   |  N   | 程序段 A assign-array-rows (单位：s) | 程序段 B assign-array-cols (单位：s) |
| :------: | :--: | :--: | :----------------------------------: | :----------------------------------: |
|    1     | 1000 |  10  |        $1.18 \times 10^{-5}$         |        $1.26 \times 10^{-5}$         |
|    2     | 100  | 100  |        $1.47 \times 10^{-5}$         |         $1.5 \times 10^{-5}$         |
|    3     |  10  | 1000 |        $1.74 \times 10^{-5}$         |        $1.84 \times 10^{-5}$         |



## 分析

对实验结果进行分析，说明局部数据块大小、数组访问顺序等和执行时间之间的关系。

- **实验1（M=1000, N=10）**:
  - **程序段A（按行访问）**：由于数组是按行存储的，因此按行访问时能够有效地利用Cache，减少了从主存到Cache的数据传输次数。因此，程序段A具有较高的Cache命中率，执行时间较短。
  - **程序段B（按列访问）**：每次访问时，由于列之间的元素在内存中不是连续的，因此需要更频繁地从主存中加载数据到Cache。这增加了Cache未命中的可能性，从而使得执行时间略长于程序段A。
- **实验2（M=100, N=100）**:
  - 在这种情况下，行和列的长度相同，但程序段A仍然因为更好的空间局部性而略占优势。这说明即使在方阵情况下，按行访问依然比按列访问更高效。
- **实验3（M=10, N=1000）**:
  - 在这种情况下，每行数据量较大，可能导致Cache中存储的数据被更频繁地替换，从而降低Cache命中率。这可能是程序段A执行时间较长的原因。然而，程序段B依然受到其较差的空间局部性的影响，因此执行时间仍然略长于程序段A。



## 总结

综合上述分析，我们可以得出结论，程序的执行时间受局部数据块大小和数组访问顺序的强烈影响。更好的空间局部性（如程序段A中的按行访问）能够显著提高程序的Cache利用率，从而提升程序执行的效率。
