# 第六章 链路层和局域网

网络层解决的问题：一个网络如何到达另外一个网络的路由问题

在一个网络内部如何由一个节点（主机或 者路由器）到达另外一个相邻节点

## 6.1 链路层概述

1. **节点**：运行链路层协议协议的任何设备，包括主机、路由器、交换机和 WiFi 接入点
2. **链路**：沿着通信路径连接相邻节点的通信信道。在通过给定的链路时，传输节点将数据报封装在链路层帧中，并将该帧传送到链路中

### 6.1.1 链路层提供的服务

1. **成帧**：在每个网络层数据报经链路传送之前，几乎所有的链路层协议都要将其用**链路层帧**封装起来
   - 一个帧由一个数据字段和若干首部字段组成，其中网络层数据报就插在数据字段中
   - 帧的结构由链路层协议规定

2. **链路接入**：**介质访问控制（MAC）协议**规定了帧在链路上传输的规则
   - 在链路的一端仅有一个发送方、链路的另一端仅有一个接收方的点对点链路， MAC 协议比较简单（或者不存在），即无论何时链路空闲，发送方都能够发送帧
   - 多路访问问题：MAC 协议协凋多个节点的帧传输

3. **可靠交付**：保证无差错地经链路层移动每个网络层数据报。
   - 通过确认和重传取得
   - 用于易于产生高差错率的链路，本地纠正差错
   - 对于低比特差错的链路，链路层可靠交付可能会被认为是一种不必要的开销

4. **差错桧测和纠正**
   - 信号衰减和电磁噪声 → 比特差错
   - 用硬件实现

### 6.1.2 链路层在何处实现

1. 在大多数情况下，链路层是在称为**网络适配器**的芯片上实现的，有时也称为**网络接口控制器（NIC）**。网络适配器实现了许多链路层服务，包括成帧、链路访问、错误检测等。因此，链路层控制器的大部分功能是在硬件中实现的
2. 在发送端，控制器取得由协议栈较高层生成并存储在主机内存中的数据报，在链路层帧中封装该数据报（填写该帧的各个字段），然后遵循链路接入协议将该帧传进通信链路中。在接收端，控制器接收了整个帧，抽取出网络层数据报。如果链路层执行差错检测，则需要发送控制器在该帧的首部设置差错检测比特，由接收控制器执行差错检测。
3. 部分链路层是在运行于主机 CPU 上的软件中实现的。软件组件实现里高层链路层功能，如组装链路层寻址信息和激活控制器硬件。在接收端，链路层软件响应控制器中断（例如，由于一个或多个帧的到达），处理差错条件和将数据报向上传递给网络层。

## 6.2 差错检测和纠正技术

### 6.2.1 奇偶校验

1. **单个奇偶校验位**：发送的信息 D 有 d 比特，发送方只需包含一个附加的比特，使得这 d+1 比特中 1 的总数是偶数。接收方能检测出**奇数**个比特差错，出现偶数个比特差错则需要二维化一般方案

2. **二维奇偶校验**：将 d 比特划分为 i 行 j 列，对每行和每列计算奇偶值，产生的 i+j+1 奇偶比特就构成了链路层帧的差错检测比特。单个比特差错可检测可纠正，二维奇偶校验能检测不能纠正

   <img src="./6链路层和局域网/image-20240613152625764.png" alt="image-20240613152625764" style="zoom: 80%;" align="left"/>

### 6.2.2 检验和方法

1. 将 d 比特数据转换为 k 比特整数的，并将 k 比特整数加起来，并用得到的和作为差错检测比特
2. 接收方通过对接收的数据（包括检验和）的和取反码，并且检测其结果是否为全 1 比特来检测检验和。如果这些比特中有任何比特是0，就可以指示出差错

### 6.2.3 循环冗余检测

- 生成多项式：对于 d 比特数据 D，发送方和接收方协商一个 r + 1 比特模式，表示为 G。G 的最高位（最左边）是 1

  <img src="./6链路层和局域网/image-20240613153904449.png" alt="image-20240613153904449" align="left"/>

- 数据 D 附加是 r 个附加比特 R，得到的 d + r 比特模式用模 2 算术恰好能被 G 整除。接收方用 G 除后余数非 - 则出现差错。

- $R = \text{remainder} \frac{D \cdot 2^r}{G}$

  <img src="./6链路层和局域网/image-20240613154239877.png" alt="image-20240613154239877" align="left"/>

## 6.3 多路访问链路和协议

1. **点对点链路**：点对点协议（PPP）和高级数据链路控制（HDLC）
2. **广播链路**
3. **多路访问问题**：如何协凋多个发送和接收节点对一个共享广播信道（如局域网）的访问。
4. 多路访问协议：规范共享的广播信道上的传输行为。传输的帧在所有的接收方处**碰撞**

![image-20240613154636550](./6链路层和局域网/image-20240613154636550.png)

### 6.3.1 信道划分协议

1. **时分多路复用（TDM）**
   - 将时间划分为时间帧，进一步划分每个时间帧为 N 个时隙，把每个时隙分配给 N 个节点中的一个
   - 优点：消除了碰撞且公平；信道的传输速率为 R，每个节点在每个帧时间内得到了专用的传输速率 R/N bps
   - 缺点：节点被限制于 R/N bps 的平均速率；节点必须等待轮次

2. **频分多路复用（FDM）**
   - 将 R bps 信道划分为不同的频段（每个频段具有 R/N 带宽），并把每个频率分配给 N 个节点中的一个
   - 优点：消除了碰撞且公平
   - 缺点：限制一个节点只能使用 R/N 的带宽

3. **码分多址（CDMA）**
   - 对每个节点分配一种不同的**编码**，每个节点用它唯一的编码来对它发送的数据进行编码
   - 能使不同的节点同时传输

### 6.3.2 随机接入协议

一个传输节点总是以信道的全部速率进行发送。当有碰撞时，涉及碰撞的每个节点反复地重发它的帧（也就是分组），到该帧无碰撞地通过为止。但是当一个节点经历一次碰撞时，它不必立刻重发该帧。相反，它在重发该帧之前等待一个随机时延。涉及碰撞的每个节点独立地选择随机时延。

1. 时隙 ALOHA

![image-20240613155855211](./6链路层和局域网/image-20240613155855211.png)

2. ALOHA

3. 载波侦听多路访问（CSMA）

   1. **载波侦听**：一个节点在传输前先听信道，如果来自另一个节点的帧正向信道上发送，节点则等待直到检测到一小段时间没有传输，然后开始传输——载波侦听多路访问（**CSMA**）
   2. **碰撞检测**：当一个传输节点在传输时一直在侦听此信道。如果它检测到另一个节点正在传输干扰帧，它就停止传输，在重复＂侦听－ 当空闲时传输＂循环之前等待一段随机时间——具有碰撞检测的 CSMA（**CSMA/CD**）

   3. 广播信道的端到端**信道传播时延**导致即使有载波侦听也会发生碰撞

   4. 从与广播信道相连的适配器的角度总结其运行

      （1）适配器从网络层一条获得数据报，准备链路层帧，并将其放入帧适配器缓存中
      （2）如果适配器侦听到信道空闲，开始传输帧。若侦听到信道正在忙，则等待
      （3）在传输过程中，适配器监视来自其他使用该广播信道的适配器的信号能量的存在
      （4）如果适配器传输整个帧而未检测到来自其他适配器的信号能扯，该适配器就完成了该帧。在另一方面，如果适配器在传输时检测到来自其他适配器的信号能量，它中止传输
      （5）中止传输后，适配器等待一个随机时间扯，然后返回步骤 2

   5. 问题：选择随机回退时间的时间间隔多大为好 → 解决：**二进制指数后退**算法
      - 当传输一个给定帧时，在该帧经历了一连串的 n 次碰撞后，节点随机从 $\{0,1,2,...,2^n-1  \}$​ 中选择一个 K 值，一个帧经历的碰撞越多， K 选择的间隔越大。对于以太网，一个节点等待的实际时间量是K • 512 比特时间
   6. CSMN/CD 效率

### 6.3.3 轮流协议

1. **轮询协议**：节点中某节点被指定为主节点。主节点以循环的方**轮询**每个节点，告诉每个节点能传输的帧的最多数量。
   - 优点：消除了困扰随机接入协议的碰撞和空时隙，效率更高
   - 缺点：轮询时延；主节点有故障，整个信道都变得不可操作

2. **令牌传递协议**：一个称为**令牌**（token）的小的特殊帧在节点之间以某种固定的次序进行交换。当一个节点收到令牌时，仅当它有一些帧要发送时，它才持有这个令牌；否则，它立即向下一个节点转发该令牌。当一个节点收到令牌时，如果它确实有帧要传输，它发送最大数目的帧数，然后把令牌转发给下一个节点。
   - 优点：分散，效率高
   - 缺点：一个节点鼓掌可能使整个信道崩溃；一个节点忘记了释放令牌，则必须调用某些恢复步骤使令牌返回到循环中来

### 6.3.4 DOCSIS：用千电缆因特网接入的链路层协议



## 6.4 交换局域网

### 6.4.1 链路层寻址和 ARP

1. **MAC 地址**（链路层地址）：
   - 主机或路由器的适配器（即网络接口）有链路层地址
   - 对于大多数局域网，MAC 地址长度为 6 字节，用十六进制表示法。共有 $2^{48}$​ 个可能的 MAC 地址
2. **地址解析协议**：转换网络层地址和 MAC 地址
   - ARP：在发送主机中的 ARP 模块将取在相同局域网上的任何 IP 地址作为输入，然后返回相应的 MAC 地址
   - 每台主机或路由器在其内存中具有一个 ARP 表，包含 IP 地址到 MAC 地址的映射关系。也包含一个寿命（TTL）值，它指示了从表中删除每个映射的时间
   - 若 ARP 表中当前没有该目的主机的表项，发送方用 ARP 协议来解析这个地址
     - 发送方构造一个称为 **ARP 查询分组**，向适配器传递且指示适配器应该用 MAC 广播地址来发送这个分组，包含该 ARP 查询的帧能被子网上的所有其他适配器接收到，并且每个适配器都把在该帧中的 ARP 分组向上传递给 ARP 模块。这些 ARP 模块中的每个都检查它的 IP 地址是否与 ARP 分组中的目的 IP 地址相匹配。与之匹配的一个给查询主机发送回一个带有所希望映射的响应ARP 分组。然后
       查询主机更新它的 ARP 表，并发送它的 IP 数据报，该数据报封装在一个链路层帧中，并且该帧的目的 MAC 就是对先前 ARP 请求进行响应的主机或路由器的 MAC 地址
3. 发送数据报到子网以外

### 6.4.2 以太网：有线局域网技术

1. 以太网成功的原因
2. 以太网帧结构
3. 无连接、不可靠服务
4. 以太网技术

### 6.4.3 链路层交换机

交换机和路由器比较：

- 都是存储转发分组交换机，但是路由器是网络层的分组交换机，交换机是链路层的分组交换机
- 都有转发表：
  - 交换机：
    - 维护交换表，按照MAC地址转发
    - 执行过滤、自学习和生成树算法
    - 即插即用；二层设备，效率高
    - 执行生成树算法，限制广播帧的转发
    - ARP表项随着站点数量增多而增多
  - 路由器：
    - 维护路由表，执行路由算法
    - 路由算法能够避免环路，无需执行生成树算法，可以以各种拓扑构建网络
    - 对广播分组做限制
    - 不是即插即用，配置网络地址(子网前缀)
    - 三层设备，速率低

### 6.4.4 虚拟局域网



## 6.5 链路虚拟化：网络作为链路层

1. 多协议标签交换（MPLS）网络：分组交换的虚电路网络
2. **多协议标签交换（MPLS）**：改善 IP 路由器的转发速度，采用固定长度标签
   - 对于基于固定长度标签和虚电路的技术，在不放弃基于目的地 IP 数据报转发的基础设施的前提下，当可能时通过选择性地标识数据报并允许路由器基于固定长度的标签（而不是目的地 IP 地址）转发数据报来增强其功能
   - 一个 MPLS 加强的帧仅能在两个均为 MPLS 使能的路由器（**为标签交换路由器**）之间发送
   - 优点：
     - 新的流量管理能力：提供了沿着多条路由转发分组的能力（流量工程）
     - 能用于执行 MPLS 转发路径的快速恢复
     - 用于实现 VPN

## 6.6 数据中心网络

### 6.6.1 数据中心体系结构

![image-20240613191806826](./6链路层和局域网/image-20240613191806826.png)

1. 数据中心中的主机称为**刀片**，在每一个机架顶部有一台交换机，这台交换机被称为**机架顶部（TOR）**交换机，机架上的每台主机都有一块与 TOR 交换机连接的网卡，每台 TOR 交换机有额外的端口能够与其他 TOR 交换机连接
2. **边界路由器**：处理外部客户与内部主机之间流动的流量
3. **负载均衡器**：向主机分发请求，以主机当前的负载作为函数来在主机之间均衡负载

4. **等级体系结构**

### 6.6.2 数据中心网络的发展趋势



## 6.7 回顾：Web 页面请求的历程



### 6.7.1 准备：DHCP 、UDP 、IP 和以太网



### 6.7.2 仍在准备：DNS 和 ARP



### 6.7.3 仍在准备：域内路由选择到 DNS 服务器



### 6.7.4 Web 客户-服务器交互：TCP和HTTP