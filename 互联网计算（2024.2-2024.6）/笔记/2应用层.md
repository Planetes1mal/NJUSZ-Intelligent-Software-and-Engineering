# 第二章 应用层

## 2.1 网络应用原理

### 2.1.1 网络应用体系结构

**客户-服务器体系结构**

服务器：

- 一直运行
- 固定的 IP 地址和周知的端口号（约定）
- 扩展性：数据中心

客户端：

- 主动与服务器通信
- 与互联网有间歇性的连接
- 可能是动态的 IP 地址
- 不直接与其他客户端通信

**P2P 体系结构**

- 几乎没有一直运行的服务器
- 任意端系统之间可以进行通信
- 每一个节点既是客户端又是服务器
  - 自扩展性：新peer节点带来新的服务能力和新的服务请求
- 参与的主机间歇性连接且可以改变 IP 地址（难以管理）

### 2.1.2 进程通信

进程：在主机上运行的应用程序

多个进程运行在相同的端系统上时，它们使用进程间通信机制相互通信

在不同端系统上的进程间通信，通过跨越计算机网络交换报文（message）

1. 客户和服务器进程

在一对进程之间的通信会话场景中，发起通信的进程被标识为客户，在会话开始时等待联系的进程是服务器

2. 进程与计算机网络之间的接口

进程通过一个称为**套接字**（socket）的软件接口向网络发送报文和从网络接收报文

套接字也称为应用程序和网络之间的应用编程接口（API）

3. 进程寻址

进程为了接收报文，必须有一个标识，即：SAP（发送也需要标示）

- 主机：唯一的32位IP地址
  - 仅仅有IP地址不能够唯一标示一个进程；在一台端系统上有很多应用进程在运行
- 所采用的传输层协议：TCP or UDP
- 端口号（Port Numbers）

一个进程：用 IP + port 标示 端节点

#### TCP之上的套接字（socket）

4元组的一个具有本地意义的标示

4元组：（源IP，源port，目标IP，目标port）

#### UDP之上的套接字（socket）

2元组的一个具有本地意义的标示

2元组：IP，port （源端指定）

### 2.1.3 可供应用程序使用的运输服务

1. 可靠数据传输
2. 吞吐量
3. 定时
4. 安全性

### 2.1.4 因特网提供的运输服务

1. TCP 服务：面向连接的服务和可靠的数据传输服务

- 面向连接的服务：TCP连接：连接双方的进程可以在此连接上同时进行报文收发
- 可靠的数据传输服务

- 拥塞控制机制

2. UDP 服务：轻量级运输协议

- 无连接
- 不可靠数据服务
- 无拥塞控制机制

## 2.2 Web & HTTP

一些术语

- Web页：由一些对象组成

- 对象可以是HTML文件、JPEG图像、Java小程序、声音剪辑文件等

- Web页含有一个基本的 HTML 文件，该基本HTML文件又包含若干对象的引用（链接）

- 通过 URL 对每个对象进行引用

- 访问协议，用户名，口令字，端口等；

- URL格式：Prot://user:psw@www.someSchool.edu/someDept/pic.gif:port

  ​		协议名 用户：口令     主机名                                路径名               端口

### 2.2.1 HTTP 概述

HTTP：超文本传输协议

客户/服务器模式

- 客户：请求、接收和显示Web对象的浏览器
- 服务器：对请求进行响应，发送对象的Web服务器

HTTP 使用 TCP 作为它的支撑运输协议
HTTP是无状态的。服务器并不维护关于客户的任何信息

### 2.2.2 非持续连接和持续连接

1. 非持续 HTTP

   最多只有一个对象在TCP连接上发送
   下载多个对象需要多个TCP连接
   HTTP/1.0使用非持久连接

   **往返时间**（RTT）：一个短分组从客户到服务器然后再返回客户所花费的时间

   - 一个RTT用来发起TCP连接

   - 一个 RTT用来HTTP请求并等待HTTP响应

   - 文件传输时间

     共：2RTT+传输时间

     <img src="E:\大二下\互联网计算\笔记\2应用层\image-20240519220310346.png" alt="image-20240519220310346" align="left" style="zoom:80%;" />

2. 持续 HTTP

   非持续 HTTP 的缺点：
   	每个对象要2个 RTT
   	操作系统必须为每个 TCP 连接分配资源
   	但浏览器通常打开并行 TCP 连接，以获取引用对象

   持续 HTTP

   服务器在发送响应后，仍保持 TCP连接
   在相同客户端和服务器之间的后 续请求和响应报文通过相同的连接进行传送
   客户端在遇到一个引用对象的时候，就可以尽快发送该对象的请求

### 2.2.3 HTTP 报文格式

两种类型的HTTP报文：请求、响应

1、HTTP 请求报文

<img src="./2应用层/image-20240520091117696.png" alt="image-20240520091117696" align="left"/>

通用格式：

<img src="./2应用层/image-20240520091236661.png" alt="image-20240520091236661" style="zoom：80%;" align="left"/>

提交表单输入：

- Post 方法：
  - 网页包含表单输入
  - 包含在实体（entity body）中的输入被提交到服务器
- URL 方法：
  - 方法：GET
  - 输入通过请求行的URL字段上载

2、HTTP 响应报文

<img src="./2应用层/image-20240520091651510.png" alt="image-20240520091651510" style="zoom:80%;" align="left"/>

HTTP 响应状态码：位于服务器 $\rightarrow$​ 客户端的响应报文中的首行

### 2.2.4 用户与服务器的交互：cookie

4个组成部分：
在HTTP响应报文中有一个cookie的首部行
在HTTP请求报文含有一个cookie的首部行
在用户端系统中保留有一个cookie文件，由用户的浏览器管理
在Web站点有一个后端数据库

### 2.2.5 Web 缓存（代理服务器）

目标：不访问原始服务器，就满足客户的请求

- 用户设置浏览器：通过缓存访问 Web
- 浏览器将所有的 HTTP 请求发给缓存
  - 在缓存中的对象：缓存直接返回对象
  - 如对象不在缓存，缓存请求原始服务器，然后再将对象返回给客户端

**条件 GET 方法**

目标：如果缓存器中的对象拷贝是最新的，就不要发送对象

缓存器：在HTTP请求中指定缓存拷贝的日期
服务器：如果缓存拷贝陈旧，则响应报文没包含对象

## 2.3 因特网中的电子邮件

3个主要组成部分：

- 用户代理（邮件阅读器）
  - 撰写、编辑和阅读邮件
  - 输入和输出邮件保存在服务器上
- 邮件服务器
  - 邮箱中管理和维护发送给用户的邮件
  - 输出报文队列保持待发送邮件报文
  - 邮件服务器之间的SMTP协议：发送email报文
    - 客户：发送方邮件服务器
    - 服务器：接收端邮件服务器

- SMTP
  - 使用TCP在客户端和服务器之间传送报文，端口号为25；使用持续连接
  - 直接传输：从发送方服务器到接收方服务器
  - 传输的3个阶段：握手、传输报文、关闭
  - 命令/响应交互
    - 命令：ASCII文本
    - 响应：状态码和状态信息
  - 报文必须为7位ASCII
- 邮件访问协议
  - SMTP：传送到接收方的邮件服务器
  - 邮件访问协议：从服务器访问邮件
    - POP：邮局访问协议（Post Office Protocol）[RFC 1939]
      - 用户身份确认 （代理<-->服务器） 并下载
    - IMAP：Internet邮件访问协议（Internet Mail Access Protocol）[RFC 1730]
      - 更多特性（更复杂）
      - 在服务器上处理存储的报文
    - HTTP：Hotmail , Yahoo! Mail等。方便

## 2.4 DNS

### 2.4.1 DNS 提供的服务

DNS 的主要思路：

- 分层的、基于域的命名机制
- 若干分布式的数据库完成名字到 IP 地址的转换
- 运行在 UDP 之上端口号为53的应用服务
- 核心的 Internet 功能，但以应用层协议实现
  - 在网络边缘处理复杂性

DNS 的主要服务：

- 实现主机名到 IP 地址的转换
- 其它目的：
  - 主机别名到规范名字的转换：Host aliasing
  - 邮件服务器别名到邮件服务器的正规名字的转换：Mail server aliasing
  - 负载均衡：Load Distribution

### 2.4.2 DNS 工作机理概述

1、分布式、层次数据库

- 根 DNS 服务器：
- 顶级域（TLD）DNS 服务器：Internet 根被划为几百个顶级域；每个（子）域下面可划分为若干子域
  - 域名（Domain Name）
    - 从本域往上，直到树根；中间使用“.”间隔不同的级别
    - 域的域名：可以用于表示一个域
      主机的域名：一个域上的一个主机
    - 域名的管理
      - 创建一个新的域，必须征得它所属域的同意
    - 域与物理网络无关
      - 域遵从组织界限，而不是物理网络
      - 一个域的主机可以不在一个网络；一个网络的主机不一定在一个域
      - 域的划分是逻辑的，而不是物理的
- 权威 DNS 服务器
  - 区域（zone）
    - 区域的划分有区域管理者自己决定
    - 将DNS名字空间划分为互不相交的区域，每个区域都是树的一部分
    - 名字服务器：每个区域都有一个名字服务器：维护着它所管辖区域的权威信息（authoritative record）
      - 名字服务器允许被放置在区域之外，以保障可靠

2、DNS  大致工作过程

应用调用解析器：

- 解析器作为客户端向 Name Server 发出查询报文（封装在 UDP 段中）
- Name Server 返回响应报文

本地名字服务器：当一个主机发起一个DNS查询时，查询被送到其本地DNS服务器；起着代理的作用，将查询转发到层次结构

名字服务器（Name Server）

- 名字解析过程
- 目标名字在本地名字服务器中
  - 情况1：查询的名字在该区域内部
    - 递归查询：名字解析负担都放在当前联络的名字服务器上
    - 迭代查询：
      - 根（及各级域名）服务器返回的不是查询结果，而是下一个NS的地址
      - 最后由权威名字服务器给出解析结果
      - 当前联络的服务器给出可以联系的服务器的名字
  - 情况2：缓存（cashing）
    - 根服务器通常都在本地服务器中缓存着，使得根服务器不用经常被访问

### 2.4.3 DNS 记录和报文

区域名字服务器维护资源记录（RR）。RR 提供了主机名到 IP 地址的映射，每个 DNS 回答报文包含了一条或多条资源记录

RR格式：（domain_name, ttl, type, class, Value）

- Domain_name：域名
- Ttl：time to live ：生存时间（权威，缓冲记录），决定了资源记录应当从缓存中删除的时间
- Class 类别 ：对于Internet，值为IN
- Value 值：可以是数字，域名或ASCII串
- Type 类别：资源记录的类型
  - Type = A：Name 为主机；Value为 IP 地址
  - Type = CNAME： Name 为规范名字的别名；value 为规范名字
  - Type = NS：Name 域名；Value 为该域名的权威服务器的域名
  - Type = MX：Value为 name 对应的邮件服务器的名字

DNS 协议：查询和响应报文的报文格式相同

<img src="./2应用层/image-20240520142652995.png" alt="image-20240520142652995" style="zoom: 67%;" align="left"/>

<img src="./2应用层/image-20240520143659842.png" alt="image-20240520143659842" style="zoom:67%;" align="left"/>

在 DNS 数据库中插入记录

## 2.5 P2P 文件分发

1、P2P 体系结构的扩展性

**分发时间**：所有 N 个对等方得到该文件的副本所需要的时间

$u_s$ 表示服务器接入链路的上载速率，$u_i$ 表示第 i 对等方接入链路的上载速率，$d_i$ 表示第 i 对等方接入链路的下载速率，F 表示被分发的文件长度，N 表示要获得该文件的副本所需要的时间

对于客户-服务器体系结构：分发时间 $D_{cs}$

- 服务器上载 N 个文件拷贝的时间 $NF/u_s$
- 对等方最小下载速率 $d_{min}$，最小下载时间 $F / d_{min}$​
- $D_{cs} \geq max \{NF/u_s,F/d_{min} \}$，取 $D_{cs} = max \{NF/u_s,F/d_{min} \}$

对于 P2P 结构：

- 服务器至少上载一份拷贝：$F/u_s$​
- 对等方最小下载速率 $d_{min}$，最小下载时间 $F / d_{min}$
- 所有客户端总体下载量 NF，系统总体上载能力 $u_{total} = u_s + u_1 + ...+ u_N$，最小上载时间 $NF/(u_s + \sum_{i=1}^N u_i)$
- $D_{P2P} \geq max \{F/u_s, F / d_{min},  NF/(u_s + \sum_{i=1}^N u_i) \}$，取 $D_{P2P} = max \{F/u_s, F / d_{min},  NF/(u_s + \sum_{i=1}^N u_i) \}$​

2、BitTorrent

## 2.6 视频流和内容分发网

### 2.6.1 因特网视频

### 2.6.2 HTTP 流和 DASH

### 2.6.3 内容分发网 CDN

两种不同的服务器安置原则：

1. 深入。通过在遍及全球的接入ISP 中部署服务器集群来深入到 ISP 的接入网中。其目标是靠近端用户，通过减少端用户和 CDN 集群之间链路和路由器的数量，从而改善了用户感受的时延和吞吐量
2. 邀请做客。通过在少量关键位置建造大集群来邀请到 ISP 做客。不是将集群放在接入 ISP 中，这些 CDN 通常将它们的集群放置在因特网交换点

## 2.7 套接字编程

### 2.7.1 TCP 套接字编程

套接字：应用进程与端到端传输协议（TCP或UDP）之间的门户
TCP服务：从一个进程向另一个进程可靠地传输字节流

服务器首先运行，等待连接建立

1. 服务器进程必须先处于运行状态
   - 创建欢迎socket
   - 和本地端口捆绑
   - 在欢迎socket上阻塞式等待接收用户的连接

客户端主动和服务器建立连接：

2. 创建客户端本地套接字（隐式捆绑到本地port）
   - 指定服务器进程的IP地址和端口号，与服务器进程连接
3. 当与客户端连接请求到来时：
   - 服务器接受来自用户端的请求，解除阻塞式等待，返回一个新的socket（与欢迎socket不一样），与客户端通信
     - 允许服务器与多个客户端通信
     - 使用源IP和源端口来区分不同的客户端
4. 连接 API 调用有效时，客户端 P 与服务器建立了 TCP 连接

### 2.7.2 UDP 套接字编程

UDP：在客户端和服务器之间没有连接

- 发送端在每一个报文中明确地指定目标的IP地址和端口号

- 服务器必须从收到的分组中提取出发送端的IP地址和端口号
